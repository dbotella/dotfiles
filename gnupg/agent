# -----------------------------------------------------------------------------
# start GPG agent
# -----------------------------------------------------------------------------

type -P gpg-agent &>/dev/null ||
    return

envFile=${GNUPGHOME:-/tmp}/agent.env

gpg_agent_is_running()
{
    declare gpgPID=$(echo $GPG_AGENT_INFO | cut -d: -f2)
    [[ $gpgPID ]] && {
        command ps -p "$gpgPID" &>/dev/null
    } || {
        return 1
    }
}

load_gpg_environment()
{
    source "$envFile" &>/dev/null
}

start_gpg_agent()
{
    gpg-agent --daemon --write-env-file $GPG_ENV &>/dev/null
    chmod 600 "$envFile"
    load_gpg_environment

    export GPG_AGENT_INFO
    export GPG_TTY=$(tty) # for PIN entry program, if any
}

if gpg_agent_is_running; then
    load_gpg_environment
else
    start_gpg_agent
fi
