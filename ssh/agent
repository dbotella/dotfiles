# -----------------------------------------------------------------------------
# start SSH agent
# based on: https://help.github.com/articles/working-with-ssh-key-passphrases
# -----------------------------------------------------------------------------

# don't use ~/.ssh/environment; it already has a different purpose in SSH
envFile=$HOME/.ssh/agent.env

# don't bother checking SSH_AGENT_PID: SSH itself doesn't use it, and it may be
# incorrect (e.g., when using agent forwarding)

ssh_agent_is_running()
{
    [[ $SSH_AUTH_SOCK ]] && {
        ssh-add -l &>/dev/null || [[ $? -eq 1 ]]
        # ssh-add returns:
        #   0 = agent running w/ keys
        #   1 = agent running w/out keys
        #   2 = agent not running
    } || {
        return 1
    }
}

ssh_agent_has_keys() {
    ssh-add -l &>/dev/null
}

load_ssh_environment()
{
    source "$envFile" &>/dev/null
}

start_ssh_agent()
{
    ssh-agent | sed 's/^echo/# echo/' >| "$envFile"
    chmod 600 "$envFile"
    load_ssh_environment
}

if ssh_agent_is_running; then
    load_ssh_environment
fi

if ssh_agent_is_running; then
    if ssh_agent_has_keys; then
        ssh-add
    fi
else
    start_ssh_agent
    ssh-add
fi

unset envFile
