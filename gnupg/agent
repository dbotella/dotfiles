# -----------------------------------------------------------------------------
# start GPG agent
# -----------------------------------------------------------------------------

# stop sourcing if gpg-agent isn't in $PATH
type -P gpg-agent &>/dev/null || return

envFile=$HOME/.gnupg/agent.env

gpg_agent_is_running()
{
    declare gpgPID=$(echo $GPG_AGENT_INFO | cut -d: -f2)

    [[ $gpgPID ]] && {
        command ps -p "$gpgPID" &>/dev/null
    } || {
        return 1
    }
}

load_gpg_environment()
{
    . "$envFile" &>/dev/null
}

start_gpg_agent()
{
    gpg-agent --daemon --write-env-file "$envFile" &>/dev/null
    chmod 600 "$envFile"
    load_gpg_environment

    export GPG_AGENT_INFO
    export GPG_TTY=$(tty) # for PIN entry program, if any
}

# -----------------------------------------------------------------------------

gpg_agent_is_running || {
    start_gpg_agent
}

rm -f "$envFile" &>/dev/null
unset envFile
